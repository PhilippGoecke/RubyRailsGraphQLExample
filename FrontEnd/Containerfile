FROM debian:trixie-slim as install

ARG DEBIAN_FRONTEND=noninteractive

# install dependencies
RUN apt update && apt upgrade -y \
  && apt install -y --no-install-recommends --no-install-suggests gnupg2 ca-certificates curl nginx openssl \
  && rm -rf "/var/lib/apt/lists/*" \
  && rm -rf /var/cache/apt/archives

# Überprüfe die Nginx Version
RUN nginx -v

# Konfigurieren Nginx: Kopieren von benutzerdefinierter Konfiguration
COPY nginx.conf /etc/nginx/nginx.conf

# Erstellen eines benutzerdefinierten, non-root Benutzers
RUN groupadd -g 101 nginx && \
    useradd -u 1001 -g nginx -s /sbin/nologin -M nginx

RUN mkdir /etc/certs \
  && openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/certs/privkey.pem -out /etc/certs/cert.pem

# Ändern der Eigentumsrechte der Nginx-Verzeichnisse
RUN chown -R nginx:nginx /var/www /var/log/nginx /var/cache/nginx /etc/certs

# Exponieren des Ports
EXPOSE 80 443

# Wechseln zu non-root Benutzer
USER nginx

# Standardbefehl zum Starten
CMD ["nginx", "-g", "daemon off;"]
